Telegram Broadcast Service

Этот проект представляет собой микросервис для рассылки сообщений пользователям Telegram. Он разработан на языке Go и предоставляет REST API, с помощью которого любые Telegram-боты, написанные на любом языке программирования, могут инициировать рассылку сообщений своим пользователям. Микросервис поддерживает отправку текстовых сообщений, фото, видео и других медиафайлов.

Цель проекта
Универсальность: Предоставить простой способ для ботов взаимодействовать с микросервисом рассылки через REST API, независимо от языка программирования.
Масштабируемость: Обеспечить возможность масштабирования и обработки большого объема сообщений.
Расширяемость: Поддерживать отправку различных типов медиафайлов (фото, видео, документы и т.д.).
Надежность: Обрабатывать ошибки и гарантировать доставку сообщений в соответствии с ограничениями Telegram API.
Асинхронность: Использовать брокер сообщений (например, NATS) для асинхронной обработки запросов на рассылку.
Структура проекта
go
Копировать код
telegram-broadcast-service/
├── cmd/
│   ├── server/
│   │   └── main.go
│   └── worker/
│       └── main.go
├── internal/
│   ├── api/
│   │   └── handlers.go
│   ├── config/
│   │   └── config.go
│   ├── database/
│   │   └── database.go
│   ├── models/
│   │   └── user.go
│   ├── telegram/
│   │   └── bot.go
│   └── messaging/
│       ├── dispatcher.go
│       └── nats.go
├── config/
│   └── config.yaml
├── go.mod
├── go.sum
└── README.md
Подробное описание структуры
cmd/
Содержит исходные файлы приложений, которые являются точками входа в программу.

cmd/server/main.go

Основное приложение, которое запускает HTTP-сервер и обрабатывает входящие API-запросы на рассылку сообщений.

cmd/worker/main.go

Воркер-приложение, которое подписывается на сообщения из системы обмена сообщениями (например, NATS) и отправляет сообщения пользователям Telegram.

internal/
Содержит внутренние пакеты приложения, недоступные извне (инкапсуляция).

internal/api/handlers.go

Содержит обработчики HTTP-запросов для API. Здесь реализованы эндпоинты для приёма запросов на рассылку и других операций.

internal/config/config.go

Пакет для загрузки и управления конфигурацией приложения. Он читает настройки из файла config.yaml и предоставляет их другим частям приложения.

internal/database/database.go

Пакет для работы с базой данных. Содержит функции для подключения к базе данных и выполнения операций, таких как получение списка пользователей.

internal/models/user.go

Определяет модели данных, используемые в приложении, например, структуру User, представляющую пользователя Telegram.

internal/telegram/bot.go

Пакет для взаимодействия с Telegram Bot API. Содержит функции для отправки текстовых сообщений, фото, видео и других медиафайлов пользователям.

internal/messaging/dispatcher.go

Содержит логику для управления рассылкой сообщений пользователям, включая соблюдение ограничений Telegram API по скорости отправки.

internal/messaging/nats.go

Пакет для взаимодействия с системой обмена сообщениями NATS. Используется для публикации и получения сообщений в асинхронном режиме.

config/config.yaml
Файл конфигурации приложения, содержащий настройки для подключения к базе данных, Telegram Bot API, NATS и другие параметры.

Пример содержимого:

yaml
Копировать код
database:
dsn: "username:password@tcp(127.0.0.1:3306)/telegram_bot_db"

telegram:
token: "YOUR_TELEGRAM_BOT_TOKEN"

nats:
url: "nats://localhost:4222"

server:
port: 8080
api_token: "YOUR_API_TOKEN"
database.dsn: Строка подключения к базе данных.
telegram.token: Токен вашего Telegram-бота.
nats.url: Адрес сервера NATS.
server.port: Порт, на котором будет работать HTTP-сервер.
server.api_token: Токен для аутентификации при вызове API.
Основные компоненты и их функции
1. HTTP-сервер (cmd/server/main.go)
   Запускает сервер, который прослушивает HTTP-запросы на указанный порт. Он принимает запросы на рассылку сообщений и передает их в систему обмена сообщениями для асинхронной обработки.

2. Воркер (cmd/worker/main.go)
   Подписывается на сообщения из NATS и обрабатывает их, отправляя сообщения пользователям через Telegram Bot API.

3. API-обработчики (internal/api/handlers.go)
   Реализуют эндпоинты REST API для взаимодействия с микросервисом. Основной эндпоинт:

POST /send-message: Принимает запрос на рассылку сообщения (текстового или медиа) определенным пользователям или всем пользователям из базы данных.
4. Конфигурация (internal/config/config.go)
   Загружает настройки приложения из файла конфигурации и предоставляет их остальным компонентам.

5. Работа с базой данных (internal/database/database.go)
   Управляет подключением к базе данных и предоставляет функции для доступа к данным пользователей.

6. Модели данных (internal/models/user.go)
   Определяет структуры данных, используемые в приложении, такие как User.

7. Взаимодействие с Telegram (internal/telegram/bot.go)
   Содержит функции для отправки различных типов сообщений через Telegram Bot API:

Текстовые сообщения
Фото
Видео
Документы
Аудио
И другие типы медиафайлов
8. Управление рассылкой сообщений (internal/messaging/dispatcher.go)
   Отвечает за отправку сообщений пользователям, соблюдая ограничения Telegram API по скорости и количеству запросов. Реализует механизм повторных попыток и обработку ошибок.

9. Взаимодействие с NATS (internal/messaging/nats.go)
   Подключается к серверу NATS для публикации и получения сообщений, что обеспечивает асинхронность и масштабируемость приложения.

Цель и возможности проекта
Цель
Создать независимый микросервис, который предоставляет API для рассылки сообщений пользователям Telegram, поддерживающий различные типы контента и обеспечивающий надежную и масштабируемую отправку сообщений с учетом ограничений Telegram API.

Возможности
Универсальный REST API: Любой Telegram-бот может взаимодействовать с микросервисом через HTTP-запросы.
Поддержка различных типов сообщений: Текст, фото, видео, документы, аудио и другие медиафайлы.
Асинхронная обработка: Использование NATS для публикации и обработки сообщений без блокировки основного потока выполнения.
Масштабируемость: Возможность запуска нескольких экземпляров воркера для обработки большого объема сообщений.
Гарантированная доставка: Реализация повторных попыток отправки сообщений и обработка ошибок, таких как ограничения Telegram API или недоступность пользователей.
Безопасность: Аутентификация запросов к API с использованием токенов.
Легкая интеграция: Простота использования для разработчиков ботов на любом языке программирования.
Как начать работу
1. Клонирование репозитория
   bash
   Копировать код
   git clone https://github.com/your_username/telegram-broadcast-service.git
   cd telegram-broadcast-service
2. Установка зависимостей
   Установите необходимые зависимости с помощью go mod:

bash
Копировать код
go mod download
3. Настройка конфигурации
   Отредактируйте файл config/config.yaml, указав свои параметры:

Токен Telegram-бота
Параметры подключения к базе данных
Адрес сервера NATS
Токен для API
4. Запуск сервера и воркера
   Запуск HTTP-сервера:

bash
Копировать код
go run cmd/server/main.go
Запуск воркера:

bash
Копировать код
go run cmd/worker/main.go
5. Использование API
   Отправьте POST-запрос на эндпоинт /send-message с необходимыми данными.

Пример запроса:

json
Копировать код
POST /send-message
Content-Type: application/json
Authorization: Bearer YOUR_API_TOKEN

{
"message": "Привет! Это тестовое сообщение.",
"media_type": "photo",
"media_url": "https://example.com/photo.jpg",
"user_ids": [123456789, 987654321]
}
Пример использования с ботом на другом языке
Если у вас есть бот на Python с использованием aiogram, вы можете отправлять запросы к микросервису следующим образом:

python
Копировать код
import aiohttp

API_URL = 'http://localhost:8080/send-message'
API_TOKEN = 'YOUR_API_TOKEN'

async def send_broadcast(message_text, media_type=None, media_url=None, user_ids=None):
headers = {
'Authorization': f'Bearer {API_TOKEN}',
'Content-Type': 'application/json'
}
data = {
'message': message_text,
'media_type': media_type,
'media_url': media_url,
'user_ids': user_ids
}

    async with aiohttp.ClientSession() as session:
        async with session.post(API_URL, json=data, headers=headers) as resp:
            if resp.status == 202:
                print('Рассылка начата')
            else:
                print('Ошибка при запуске рассылки:', await resp.text())
Дополнительные сведения
Безопасность
Используйте HTTPS для защиты передаваемых данных.
Храните токены доступа в безопасном месте и не включайте их в систему контроля версий.
Реализуйте ограничение доступа по IP или другим параметрам, если необходимо.
Масштабирование
Вы можете запускать несколько экземпляров воркера для повышения производительности.
NATS обеспечивает балансировку нагрузки между воркерами.
Мониторинг и логирование
Внедрите системы мониторинга (Prometheus, Grafana) для отслеживания состояния сервиса.
Используйте структурированное логирование для упрощения анализа и отладки.
Обработка ошибок
Реализуйте обработку специфических ошибок Telegram API (например, блокировка бота пользователем).
Добавьте механизмы повторных попыток с экспоненциальной задержкой при временных ошибках.
Полезные ресурсы
Go Documentation: golang.org/doc
Telegram Bot API: core.telegram.org/bots/api
NATS Documentation: nats.io
go-telegram-bot-api: github.com/go-telegram-bot-api/telegram-bot-api
aiogram Documentation: docs.aiogram.dev
Контакты
Если у вас есть вопросы или предложения по улучшению проекта, пожалуйста, создайте issue в репозитории или свяжитесь со мной по электронной почте: [your_email@example.com].

Примечание: Замените YOUR_TELEGRAM_BOT_TOKEN, YOUR_API_TOKEN, your_username, your_email@example.com и другие placeholder'ы на реальные значения.

Лицензия
Этот проект лицензирован под лицензией MIT. Подробности см. в файле LICENSE.

Краткое описание структуры проекта
telegram-broadcast-service/: Корневая директория проекта.

cmd/: Содержит приложения, которые запускаются из командной строки.

server/:

main.go: Точка входа для HTTP-сервера. Обрабатывает входящие API-запросы на рассылку.
worker/:

main.go: Точка входа для воркера. Подписывается на сообщения из NATS и отправляет сообщения пользователям Telegram.
internal/: Содержит внутренние пакеты приложения.

api/:

handlers.go: Реализация HTTP-обработчиков для API эндпоинтов.
config/:

config.go: Загрузка и управление конфигурацией приложения.
database/:

database.go: Подключение к базе данных и функции для доступа к данным.
models/:

user.go: Определение моделей данных, таких как User.
telegram/:

bot.go: Взаимодействие с Telegram Bot API, функции для отправки сообщений и медиафайлов.
messaging/:

dispatcher.go: Управление рассылкой сообщений, включая обработку ограничений Telegram API.

nats.go: Подключение и взаимодействие с NATS для публикации и получения сообщений.

config/:

config.yaml: Файл конфигурации приложения с настройками для базы данных, Telegram, NATS и сервера.
go.mod и go.sum: Файлы модулей Go для управления зависимостями.

README.md: Документация проекта.